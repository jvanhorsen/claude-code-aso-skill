name: Wiki Sync

on:
  push:
    branches: [main]
    paths:
      - 'README.md'
      - 'CHANGELOG.md'
      - 'CLAUDE.md'
      - 'PROJECT-STATUS.md'
      - 'documentation/**'
      - 'app-store-optimization/**/*.py'
      - '.github/workflows/wiki-sync.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-wiki:
    name: Sync Content to Wiki
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Checkout wiki repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Generate wiki content
        run: |
          python scripts/generate-wiki-content.py

      - name: Copy generated wiki files
        run: |
          # Copy generated files to wiki
          cp -f /tmp/wiki/*.md wiki/ 2>/dev/null || echo "No wiki files generated yet"

          # Create wiki homepage
          cat > wiki/Home.md << 'EOF'
# ASO Skill Wiki

Welcome to the comprehensive ASO (App Store Optimization) Skill documentation!

## Quick Navigation

### Getting Started
- [Installation Guide](Installation)
- [Quick Start](Quick-Start)
- [Configuration](Configuration)

### Core Features
- [Keyword Analysis](Keyword-Analysis)
- [Metadata Optimization](Metadata-Optimization)
- [Competitor Analysis](Competitor-Analysis)
- [A/B Testing](AB-Testing)
- [Localization](Localization)
- [Review Analysis](Review-Analysis)
- [Launch Planning](Launch-Planning)

### ASO Agents
- [Agent Overview](ASO-Agents)
- [aso-master](ASO-Agent-Master)
- [aso-research](ASO-Agent-Research)
- [aso-metadata](ASO-Agent-Metadata)
- [aso-creative](ASO-Agent-Creative)
- [aso-launch](ASO-Agent-Launch)
- [aso-ongoing](ASO-Agent-Ongoing)

### Reference
- [API Documentation](API-Reference)
- [Platform Constraints](Platform-Constraints)
- [Character Limits](Character-Limits)

### Project
- [Release History](Release-History)
- [Roadmap](Roadmap)
- [Contributing](Contributing)
- [FAQ](FAQ)

---

**Version:** 1.4.1 | **Updated:** $(date +"%B %d, %Y")
          EOF

          # Extract sections from README for Installation and Quick Start
          sed -n '/## Installation/,/## Usage/p' README.md | sed '$ d' > wiki/Installation.md
          sed -n '/## Quick Start/,/## Features/p' README.md | sed '$ d' > wiki/Quick-Start.md

          # Copy CHANGELOG as Release History
          cp CHANGELOG.md wiki/Release-History.md

          # Copy PROJECT-STATUS as Roadmap
          cp PROJECT-STATUS.md wiki/Roadmap.md

          # Copy CONTRIBUTING
          cp .github/CONTRIBUTING.md wiki/Contributing.md

          # Create Platform Constraints page
          cat > wiki/Platform-Constraints.md << 'EOF'
# Platform Constraints

## Character Limit Reference

### Apple App Store

| Field | Limit | Notes |
|-------|-------|-------|
| Title | 30 characters | Critical for visibility |
| Subtitle | 30 characters | Displays under app name |
| Promotional Text | 170 characters | Can update without new version |
| Description | 4000 characters | Not indexed for search |
| Keywords | 100 characters | Comma-separated, no spaces |

### Google Play Store

| Field | Limit | Notes |
|-------|-------|-------|
| Title | 50 characters | Indexed for search |
| Short Description | 80 characters | First thing users see |
| Full Description | 4000 characters | Indexed for search |
| Keywords | N/A | Extracted from title/description |

## Best Practices

### Apple App Store
- Use all 100 characters for keywords
- No spaces after commas in keyword field
- Keywords not in title/subtitle still count
- Test with App Store Connect preview

### Google Play Store
- Front-load important keywords in title
- Use short description wisely (80 chars)
- Include keywords naturally in full description
- No keyword stuffing (penalized)

## Validation

All ASO skill modules automatically validate character limits:

```bash
# Run module directly to verify installation
python app-store-optimization/lib/itunes_api.py
```

**Last Updated:** $(date +"%B %d, %Y")
          EOF

          echo "✅ Wiki content prepared"

      - name: Commit and push to wiki
        working-directory: wiki
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if git diff --staged --quiet; then
            echo "No changes to wiki"
          else
            git commit -m "Auto-sync from main branch: ${{ github.sha }}"
            git push
            echo "✅ Wiki updated successfully"
          fi

      - name: Summary
        run: |
          echo "## Wiki Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Updated wiki from main branch push." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files synced:**" >> $GITHUB_STEP_SUMMARY
          echo "- Home.md (generated)" >> $GITHUB_STEP_SUMMARY
          echo "- Installation.md (from README)" >> $GITHUB_STEP_SUMMARY
          echo "- Quick-Start.md (from README)" >> $GITHUB_STEP_SUMMARY
          echo "- Release-History.md (from CHANGELOG)" >> $GITHUB_STEP_SUMMARY
          echo "- Roadmap.md (from PROJECT-STATUS)" >> $GITHUB_STEP_SUMMARY
          echo "- Contributing.md (from .github/CONTRIBUTING)" >> $GITHUB_STEP_SUMMARY
          echo "- Platform-Constraints.md (generated)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Wiki URL:** https://github.com/${{ github.repository }}/wiki" >> $GITHUB_STEP_SUMMARY
